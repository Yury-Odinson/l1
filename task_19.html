<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="./styles.css">

    <title>Task 19</title>
</head>

<body>
    <div class="container19">
        <div class="container19-header">
            <a href="./index.html">
                <button>Назад, к заданиям</button>
            </a>

            <button id="auth__button">Authorization</button>
        </div>



        <div class="container-body19">
        </div>

        <template id="post__template">
            <div class="post-item">
                <img class="post-item__photo" width="500" height="300">
                <span class="post-item__text"></span>
                <div class="post-item-footer">
                    <div class="post-item-footer-like">
                        <img src="./img/like.png" width="20" height="20">
                        <span class="post-item__likes"></span>
                    </div>
                    <div class="post-item-footer-repost">
                        <img src="./img/share.png" width="20" height="20">
                        <span class="post-item__reposts"></span>
                    </div>
                    <div class="post-item-footer-views">
                        <img src="./img/eye.png" width="20" height="20">
                        <span class="post-item__views"></span>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script type="text/javascript">
        const container = document.querySelector(".container19")
        const bodyPosts = document.querySelector(".container-body19")
        let hash = window.location.hash
        let token = hash.substr(hash.indexOf('access_token=')).split('&')[0].split('=')[1]

        const template = document.getElementById("post__template")
        const containerBody = document.querySelector(".container-body19")

        var script = document.createElement('SCRIPT');
        script.src = `https://api.vk.com/method/wall.get?owner_id=1&v=5.154&access_token=${token}&count=100&callback=callbackFunc`;
        document.getElementsByTagName("head")[0].appendChild(script);
        function callbackFunc(result) {

            const response = result.response.items              // массив всех постов
            const pagesPost = []                                // заготовка массива разбитого на части (для пагинации)
            let thisPage = localStorage.getItem("page") || 0    // текущая страница для рендера
            console.log(response.length)
            for (let i = 0; i < response.length; i += 5) {
                pagesPost.push(response.slice(i, i + 5))
            }

            container.addEventListener("scroll", () => {
                if (container.scrollHeight - container.scrollTop === container.clientHeight) {
                    console.log("down")
                    thisPage++
                    renderPosts(thisPage)
                    localStorage.setItem("page", thisPage)
                }
            })

            const renderPosts = (page) => {
                pagesPost[page].map(element => {
                    const clone = template.content.cloneNode(true)
                    const postText = clone.querySelector(".post-item__text")
                    const postImg = clone.querySelector(".post-item__photo")
                    const postLikes = clone.querySelector(".post-item__likes")
                    const postReposts = clone.querySelector(".post-item__reposts")
                    const postViews = clone.querySelector(".post-item__views")
                    postImg.style.display = "none"
                    postText.textContent = element.text
                    postLikes.textContent = element.likes.count
                    postReposts.textContent = element.reposts.count
                    postViews.textContent = element.views.count
                    if (element.attachments[0]?.photo) {
                        postImg.style.display = "block"
                        postImg.src = element.attachments[0]?.photo?.sizes[4].url
                    }
                    bodyPosts.appendChild(clone)
                })
            }
            renderPosts(thisPage)
        }
    </script>

    <script src="./task_19.js"></script>
</body>

</html>